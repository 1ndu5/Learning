<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Basic Math Facts Worksheet Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- InstantDB SDK -->
    <script src="https://www.unpkg.com/@instantdb/core@latest/dist/standalone/index.umd.cjs"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #printable, #printable * {
                visibility: visible;
            }
            #printable {
                position: absolute;
                left: 0;
                top: 0;
            }
            .print\\:hidden {
                display: none !important;
            }
        }
        @page {
          margin: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==== Cloud config ====
        const INSTANTDB_APP_ID = '2275819f-2db8-499c-990a-e37b075e0cef';
        const SNAPSHOT_COLLECTION = 'snapshots';

        // #region agent log helper
        const debugLog = (hypothesisId, location, message, data = {}, runId = 'run1') => {
          fetch('http://127.0.0.1:7242/ingest/cd4d49cf-b3ae-442d-8695-426e0f27e7ab', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              sessionId: 'debug-session',
              runId,
              hypothesisId,
              location,
              message,
              data,
              timestamp: Date.now()
            })
          }).catch(() => {});
        };
        // #endregion

        const MathPracticeApp = () => {
          const [view, setView] = useState('setup');
          const [currentWorksheet, setCurrentWorksheet] = useState(null);
          const [worksheetId, setWorksheetId] = useState(null);
          const [quickGradeWrong, setQuickGradeWrong] = useState('');
          const [quickGradeIncomplete, setQuickGradeIncomplete] = useState('');
          const [selectedWorksheetToGrade, setSelectedWorksheetToGrade] = useState('');
          const [gradingHistory, setGradingHistory] = useState([]);

          const [users, setUsers] = useState(['Default']);
          const [currentUser, setCurrentUser] = useState('Default');
          const [showUserModal, setShowUserModal] = useState(false);
          const [newUserName, setNewUserName] = useState('');
          const [editingUsers, setEditingUsers] = useState(false);

          const [categories, setCategories] = useState({
            numberBonds5: false,
            numberBonds10: false,
            numberBonds100: false,
            additionSingle: false,
            additionDoubleNoCarry: false,
            additionDoubleCarry: false,
            subtractionSingle: false,
            subtractionDoubleNoCarry: false,
            subtractionDoubleCarry: false,
            multiplication: [],
            division: []
          });

          const [adaptiveWeight, setAdaptiveWeight] = useState(0.5);
          const [allUserData, setAllUserData] = useState({});
          const [savedWorksheets, setSavedWorksheets] = useState({});

          // Cloud / auth state
          const [instantClient, setInstantClient] = useState(null);
          const [cloudUser, setCloudUser] = useState(null);
          const [loginInFlight, setLoginInFlight] = useState(false);
          const [authEmailDisplay, setAuthEmailDisplay] = useState('');
          const [metaUpdatedAt, setMetaUpdatedAt] = useState({ users: null, allUserData: null, savedWorksheets: null });

          const [worksheetDisplayCount, setWorksheetDisplayCount] = useState(5);
          const [statsDisplayCount, setStatsDisplayCount] = useState(20);
          
          // First useEffect - Load saved data from localStorage
          useEffect(() => {
            debugLog('A', 'basic-math-worksheets.html:load', 'initial window.instant presence', {
              hasInstant: !!window.instant,
              appIdConfigured: INSTANTDB_APP_ID !== '2275819f-2db8-499c-990a-e37b075e0cef' ? 'custom' : 'set',
              appId: INSTANTDB_APP_ID
            });
            
            const savedUsers = localStorage.getItem('mathPracticeUsers');
            const savedData = localStorage.getItem('mathPracticeAllData');
            const savedSheets = localStorage.getItem('mathPracticeSavedWorksheets');
            const savedMeta = localStorage.getItem('mathPracticeMeta');

            if (savedUsers) {
              const parsedUsers = JSON.parse(savedUsers);
              setUsers(parsedUsers);
              if (parsedUsers.length > 0 && !parsedUsers.includes(currentUser)) {
                setCurrentUser(parsedUsers[0]);
              }
            }

            if (savedData) {
              setAllUserData(JSON.parse(savedData));
            }

            if (savedSheets) {
              setSavedWorksheets(JSON.parse(savedSheets));
            }

            if (savedMeta) {
              try {
                setMetaUpdatedAt(JSON.parse(savedMeta));
              } catch (e) {
                console.warn('Could not parse meta info', e);
              }
            }
          }, []);

          // Second useEffect - Load categories for current user
          useEffect(() => {
            const savedCategories = localStorage.getItem(`categories-${currentUser}`);
            if (savedCategories) {
              setCategories(JSON.parse(savedCategories));
            }
          }, [currentUser]);

          // Third useEffect - Initialize InstantDB (ONLY ONE INITIALIZATION)
          useEffect(() => {
            if (!window.instant || INSTANTDB_APP_ID === 'YOUR_INSTANTDB_APP_ID') return;
            try {
              debugLog('A', 'basic-math-worksheets.html:init', 'attempting init', {
                hasInstant: !!window.instant,
                appId: INSTANTDB_APP_ID
              });
              
              const { init } = window.instant;
              const client = init({ appId: INSTANTDB_APP_ID });
              setInstantClient(client);
              
              const unsub = client.auth.onAuthStateChange((user) => {
                setCloudUser(user || null);
                setAuthEmailDisplay(user?.email || '');
              });
              
              debugLog('A', 'basic-math-worksheets.html:init', 'init success', {
                hasClient: !!client,
                hasAuth: !!client?.auth
              });
              return () => unsub && unsub();
            } catch (err) {
              debugLog('A', 'basic-math-worksheets.html:init', 'init error', { error: String(err) });
              console.warn('InstantDB init failed', err);
            }
          }, []);

          // Fourth useEffect - Sync with cloud when user logs in
          useEffect(() => {
            if (!cloudUser || !instantClient) return;
            (async () => {
              const cloudSnap = await fetchCloudSnapshot();
              const localSnap = buildSnapshot();
              const merged = mergeSnapshots(localSnap, cloudSnap);
              applyMergedSnapshot(merged);
              await pushCloudSnapshot();
            })();
          }, [cloudUser, instantClient]);

          const touchMeta = (key) => {
            const now = new Date().toISOString();
            setMetaUpdatedAt(prev => {
              const next = { ...prev, [key]: now };
              localStorage.setItem('mathPracticeMeta', JSON.stringify(next));
              return next;
            });
            return now;
          };

          const buildSnapshot = () => ({
            users,
            allUserData,
            savedWorksheets,
            meta: metaUpdatedAt
          });

          const mergeSnapshots = (localSnap, cloudSnap) => {
            if (!cloudSnap) return { ...localSnap };

            const mergedMeta = { ...(localSnap.meta || {}), ...(cloudSnap.meta || {}) };

            const pickByMeta = (key, fallback) => {
              const lTime = new Date(localSnap.meta?.[key] || 0).getTime();
              const cTime = new Date(cloudSnap.meta?.[key] || 0).getTime();
              if (cTime > lTime) return cloudSnap[key] ?? fallback;
              return localSnap[key] ?? fallback;
            };

            const mergedUsers = pickByMeta('users', []);
            const mergedAllUserData = {};
            const allUserKeys = new Set([
              ...Object.keys(localSnap.allUserData || {}),
              ...Object.keys(cloudSnap.allUserData || {})
            ]);

            allUserKeys.forEach(u => {
              const localEntry = (localSnap.allUserData || {})[u];
              const cloudEntry = (cloudSnap.allUserData || {})[u];
              const lTime = new Date(localEntry?.updatedAt || localSnap.meta?.allUserData || 0).getTime();
              const cTime = new Date(cloudEntry?.updatedAt || cloudSnap.meta?.allUserData || 0).getTime();
              mergedAllUserData[u] = cTime > lTime ? cloudEntry || localEntry : localEntry || cloudEntry;
            });

            const mergedSavedWorksheets = {};
            const allWorksheetUsers = new Set([
              ...Object.keys(localSnap.savedWorksheets || {}),
              ...Object.keys(cloudSnap.savedWorksheets || {})
            ]);

            allWorksheetUsers.forEach(u => {
              const localWs = (localSnap.savedWorksheets || {})[u] || {};
              const cloudWs = (cloudSnap.savedWorksheets || {})[u] || {};
              const mergedUserWs = {};
              const wsKeys = new Set([...Object.keys(localWs), ...Object.keys(cloudWs)]);
              wsKeys.forEach(id => {
                const lWs = localWs[id];
                const cWs = cloudWs[id];
                const lTime = new Date(lWs?.updatedAt || lWs?.createdAt || 0).getTime();
                const cTime = new Date(cWs?.updatedAt || cWs?.createdAt || 0).getTime();
                mergedUserWs[id] = cTime > lTime ? cWs || lWs : lWs || cWs;
              });
              mergedSavedWorksheets[u] = mergedUserWs;
            });

            return {
              users: mergedUsers,
              allUserData: mergedAllUserData,
              savedWorksheets: mergedSavedWorksheets,
              meta: mergedMeta
            };
          };

          const applyMergedSnapshot = (snapshot) => {
            if (!snapshot) return;
            setUsers(snapshot.users || []);
            setAllUserData(snapshot.allUserData || {});
            setSavedWorksheets(snapshot.savedWorksheets || {});
            setMetaUpdatedAt(snapshot.meta || {});

            localStorage.setItem('mathPracticeUsers', JSON.stringify(snapshot.users || []));
            localStorage.setItem('mathPracticeAllData', JSON.stringify(snapshot.allUserData || {}));
            localStorage.setItem('mathPracticeSavedWorksheets', JSON.stringify(snapshot.savedWorksheets || {}));
            localStorage.setItem('mathPracticeMeta', JSON.stringify(snapshot.meta || {}));
          };

          const pushCloudSnapshot = async () => {
            if (!instantClient || !cloudUser || !navigator.onLine) return;
            try {
              const snapshot = buildSnapshot();
              const payload = {
                data: snapshot,
                updatedAt: new Date().toISOString(),
                id: cloudUser.id
              };
              await instantClient.transact([
                instantClient.tx[SNAPSHOT_COLLECTION][cloudUser.id].update(payload)
              ]);
            } catch (err) {
              console.warn('Cloud push skipped', err);
            }
          };

          const fetchCloudSnapshot = async () => {
            if (!instantClient || !cloudUser || !navigator.onLine) return null;
            try {
              const res = await instantClient.query({
                [SNAPSHOT_COLLECTION]: {
                  $: {
                    where: { id: cloudUser.id },
                    limit: 1
                  }
                }
              });
              const record = res?.[SNAPSHOT_COLLECTION]?.[0];
              return record?.data || null;
            } catch (err) {
              console.warn('Cloud fetch skipped', err);
              return null;
            }
          };

          async function maybePushCloudSnapshot() {
            await pushCloudSnapshot();
          }

          const getCurrentUserData = () => {
            return allUserData[currentUser] || { questionHistory: {} };
          };

          const saveUserData = (userData) => {
            const stamped = { ...userData, updatedAt: new Date().toISOString() };
            const newAllData = {
              ...allUserData,
              [currentUser]: stamped
            };
            setAllUserData(newAllData);
            localStorage.setItem('mathPracticeAllData', JSON.stringify(newAllData));
            touchMeta('allUserData');
            maybePushCloudSnapshot();
          };

          const saveUsers = (userList) => {
            setUsers(userList);
            localStorage.setItem('mathPracticeUsers', JSON.stringify(userList));
            touchMeta('users');
            maybePushCloudSnapshot();
          };

          const saveWorksheets = (worksheets) => {
            const now = new Date().toISOString();
            Object.values(worksheets).forEach(userWs => {
              Object.values(userWs || {}).forEach(ws => {
                if (!ws.updatedAt) {
                  ws.updatedAt = ws.createdAt || now;
                }
              });
            });
            setSavedWorksheets(worksheets);
            localStorage.setItem('mathPracticeSavedWorksheets', JSON.stringify(worksheets));
            touchMeta('savedWorksheets');
            maybePushCloudSnapshot();
          };

          const addUser = () => {
            if (newUserName.trim() && !users.includes(newUserName.trim())) {
              const updatedUsers = [...users, newUserName.trim()];
              saveUsers(updatedUsers);
              setCurrentUser(newUserName.trim());
              setWorksheetDisplayCount(5);
              setStatsDisplayCount(20);
              setNewUserName('');
              setShowUserModal(false);
            } else {
              alert('Please enter a unique name');
            }
          };

          const deleteUser = (userName) => {
            if (users.length === 1) {
              alert('Cannot delete the last user');
              return;
            }
            if (confirm(`Are you sure you want to delete ${userName} and all their data?`)) {
              const updatedUsers = users.filter(u => u !== userName);
              saveUsers(updatedUsers);

              const newAllData = { ...allUserData };
              delete newAllData[userName];
              setAllUserData(newAllData);
              localStorage.setItem('mathPracticeAllData', JSON.stringify(newAllData));

              const newWorksheets = { ...savedWorksheets };
              delete newWorksheets[userName];
              saveWorksheets(newWorksheets);

              if (currentUser === userName) {
                setCurrentUser(updatedUsers[0]);
              }
            }
          };

          const exportData = () => {
            const userData = getCurrentUserData();
            const userWorksheets = savedWorksheets[currentUser] || {};
            const data = JSON.stringify({
              user: currentUser,
              questionHistory: userData.questionHistory,
              worksheets: userWorksheets
            }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `math-practice-${currentUser}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
          };

          const importData = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                try {
                  const data = JSON.parse(event.target.result);
                  const importUser = data.user || 'Imported';

                  if (!users.includes(importUser)) {
                    saveUsers([...users, importUser]);
                  }

                  const newAllData = {
                    ...allUserData,
                    [importUser]: { questionHistory: data.questionHistory || {} }
                  };
                  setAllUserData(newAllData);
                  localStorage.setItem('mathPracticeAllData', JSON.stringify(newAllData));

                  const newWorksheets = {
                    ...savedWorksheets,
                    [importUser]: data.worksheets || {}
                  };
                  saveWorksheets(newWorksheets);

                  setCurrentUser(importUser);
                  setWorksheetDisplayCount(5);
                  setStatsDisplayCount(20);
                  alert('Data imported successfully!');
                } catch (err) {
                  alert('Error importing data. Please check the file format.');
                }
              };
              reader.readAsText(file);
            }
          };

          const generateQuestionKey = (q) => {
            return `${q.type}:${q.display}`;
          };

          const getQuestionStats = (key) => {
            const userData = getCurrentUserData();
            const history = userData.questionHistory[key] || { attempts: [], totalAsked: 0, totalCorrect: 0 };
            const recentAttempts = history.attempts.slice(-20);
            const recentCorrect = recentAttempts.filter(a => a).length;
            const recentPercentage = recentAttempts.length > 0 ? (recentCorrect / recentAttempts.length) : 1;
            return { ...history, recentPercentage, recentAttempts: recentAttempts.length };
          };

          const generateNumberBond5 = () => {
            const target = 5;
            const a = Math.floor(Math.random() * 6);
            const b = target - a;
            const formats = [
              { display: `${a} + ___ = ${target}`, answer: b, type: 'numberBonds5' },
              { display: `${target} - ${a} = ___`, answer: b, type: 'numberBonds5' },
              { display: `${target} - ___ = ${a}`, answer: b, type: 'numberBonds5' }
            ];
            return formats[Math.floor(Math.random() * formats.length)];
          };

          const generateNumberBond10 = () => {
            const target = 10;
            const a = Math.floor(Math.random() * 11);
            const b = target - a;
            const formats = [
              { display: `${a} + ___ = ${target}`, answer: b, type: 'numberBonds10' },
              { display: `${target} - ${a} = ___`, answer: b, type: 'numberBonds10' },
              { display: `${target} - ___ = ${a}`, answer: b, type: 'numberBonds10' }
            ];
            return formats[Math.floor(Math.random() * formats.length)];
          };

          const generateNumberBond100 = () => {
            const target = 100;
            const a = Math.floor(Math.random() * 11) * 10;  // This gives 0, 10, 20, ... 100
            const b = target - a;
            const formats = [
              { display: `${a} + ___ = ${target}`, answer: b, type: 'numberBonds100' },
              { display: `${target} - ${a} = ___`, answer: b, type: 'numberBonds100' },
              { display: `${target} - ___ = ${a}`, answer: b, type: 'numberBonds100' }
            ];
            return formats[Math.floor(Math.random() * formats.length)];
          };

          const generateAdditionSingle = () => {
            const a = Math.floor(Math.random() * 10);
            const b = Math.floor(Math.random() * 10);
            return { display: `${a} + ${b} = ___`, answer: a + b, type: 'additionSingle' };
          };

          const generateAdditionDoubleNoCarry = () => {
            let a, b;
            do {
              a = Math.floor(Math.random() * 80) + 10;  // Now 10-89, leaving room for double-digit b
              const maxB = 99 - a;  // maxB will be 10-89
              b = Math.floor(Math.random() * (maxB - 9)) + 10;  // b will be 10 to maxB
              
              const onesA = a % 10;
              const onesB = b % 10;
              const tensA = Math.floor(a / 10);
              const tensB = Math.floor(b / 10);
              
              if (onesA + onesB < 10 && tensA + tensB < 10) break;
            } while (true);
            
            return { display: `${a} + ${b} = ___`, answer: a + b, type: 'additionDoubleNoCarry' };
          };

          const generateAdditionDoubleCarry = () => {
            let a, b;
            do {
              a = Math.floor(Math.random() * 80) + 10;  // Now 10-89, leaving room for double-digit b
              const maxB = 99 - a;  // maxB will be 10-89
              b = Math.floor(Math.random() * (maxB - 9)) + 10;  // b will be 10 to maxB
              
              const onesA = a % 10;
              const onesB = b % 10;
              const tensA = Math.floor(a / 10);
              const tensB = Math.floor(b / 10);
              
              if (onesA + onesB >= 10 || tensA + tensB >= 10) break;
            } while (true);
            
            return { display: `${a} + ${b} = ___`, answer: a + b, type: 'additionDoubleCarry' };
          };

          const generateSubtractionSingle = () => {
            const a = Math.floor(Math.random() * 10);
            const b = Math.floor(Math.random() * (a + 1));
            return { display: `${a} - ${b} = ___`, answer: a - b, type: 'subtractionSingle' };
          };

          const generateSubtractionDoubleNoCarry = () => {
            let a, b;
            do {
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * a) + 1;
              
              const onesA = a % 10;
              const onesB = b % 10;
              const tensA = Math.floor(a / 10);
              const tensB = Math.floor(b / 10);
              
              if (onesA >= onesB && tensA >= tensB && a - b >= 0) break;
            } while (true);
            
            return { display: `${a} - ${b} = ___`, answer: a - b, type: 'subtractionDoubleNoCarry' };
          };

          const generateSubtractionDoubleCarry = () => {
            let a, b;
            do {
              a = Math.floor(Math.random() * 90) + 10;
              b = Math.floor(Math.random() * a) + 1;
              
              const onesA = a % 10;
              const onesB = b % 10;
              const tensA = Math.floor(a / 10);
              const tensB = Math.floor(b / 10);
              
              if ((onesA < onesB || tensA < tensB) && a - b >= 0) break;
            } while (true);
            
            return { display: `${a} - ${b} = ___`, answer: a - b, type: 'subtractionDoubleCarry' };
          };

          const generateMultiplication = (table) => {
            const other = Math.floor(Math.random() * 12) + 1;
            const flip = Math.random() > 0.5;
            const [a, b] = flip ? [table, other] : [other, table];
            return { display: `${a} √ó ${b} = ___`, answer: a * b, type: `multiplication${table}` };
          };

          const generateDivision = (table) => {
            const other = Math.floor(Math.random() * 12) + 1;
            const product = table * other;
            return { display: `${product} √∑ ${table} = ___`, answer: other, type: `division${table}` };
          };

          const generateQuestions = () => {
            const activeCategories = [];

            if (categories.numberBonds5) activeCategories.push({ gen: generateNumberBond5, weight: 1 });
            if (categories.numberBonds10) activeCategories.push({ gen: generateNumberBond10, weight: 1 });
            if (categories.numberBonds100) activeCategories.push({ gen: generateNumberBond100, weight: 1 });
            if (categories.additionSingle) activeCategories.push({ gen: generateAdditionSingle, weight: 1 });
            if (categories.additionDoubleNoCarry) activeCategories.push({ gen: generateAdditionDoubleNoCarry, weight: 1 });
            if (categories.additionDoubleCarry) activeCategories.push({ gen: generateAdditionDoubleCarry, weight: 1 });
            if (categories.subtractionSingle) activeCategories.push({ gen: generateSubtractionSingle, weight: 1 });
            if (categories.subtractionDoubleNoCarry) activeCategories.push({ gen: generateSubtractionDoubleNoCarry, weight: 1 });
            if (categories.subtractionDoubleCarry) activeCategories.push({ gen: generateSubtractionDoubleCarry, weight: 1 });

            categories.multiplication.forEach(table => {
              activeCategories.push({ gen: () => generateMultiplication(table), weight: 1 });
            });

            categories.division.forEach(table => {
              activeCategories.push({ gen: () => generateDivision(table), weight: 1 });
            });

            if (activeCategories.length === 0) {
              alert('Please select at least one question type!');
              return null;
            }

            const questions = [];
            const questionPool = [];

            for (let i = 0; i < 500; i++) {
              const category = activeCategories[Math.floor(Math.random() * activeCategories.length)];
              const q = category.gen();
              const key = generateQuestionKey(q);
              const stats = getQuestionStats(key);

              let selectionWeight = 1;
              if (stats.recentAttempts > 0) {
                selectionWeight = 1 + (1 - stats.recentPercentage) * adaptiveWeight * 5;
              }

              questionPool.push({ ...q, key, selectionWeight });
            }

            for (let i = 0; i < 100; i++) {
              const totalWeight = questionPool.reduce((sum, q) => sum + q.selectionWeight, 0);
              let random = Math.random() * totalWeight;

              for (let j = 0; j < questionPool.length; j++) {
                random -= questionPool[j].selectionWeight;
                if (random <= 0) {
                  questions.push({ ...questionPool[j], id: i });
                  questionPool.splice(j, 1);
                  break;
                }
              }

              if (questionPool.length === 0) break;
            }

            return questions;
          };

          const handleAuthButton = async () => {
            debugLog('B', 'basic-math-worksheets.html:handleAuthButton', 'click', {
              hasInstantClient: !!instantClient,
              hasCloudUser: !!cloudUser,
              loginInFlight
            });
            if (!instantClient) {
              alert('Cloud not configured. Set INSTANTDB_APP_ID and reload.');
              return;
            }

            if (cloudUser) {
              try {
                await instantClient.auth.signOut();
              } catch (err) {
                console.warn('Sign out failed', err);
              }
              return;
            }

            const email = prompt('Enter your email to receive a magic link:');
            if (!email) return;
            setLoginInFlight(true);
            try {
              await instantClient.auth.sendMagicLinkEmail(email, { redirectTo: window.location.href });
              alert('Magic link sent. Please check your email.');
            } catch (err) {
              alert('Could not send magic link. Please try again.');
              console.warn(err);
            } finally {
              setLoginInFlight(false);
            }
          };

          const handleGenerateWorksheet = () => {
            const questions = generateQuestions();

            // Save current category selections for this user
            localStorage.setItem(`categories-${currentUser}`, JSON.stringify(categories));

            if (questions) {
              const id = `WS-${Date.now()}`;
              const worksheet = {
                id: id,
                questions: questions,
                user: currentUser,
                createdAt: new Date().toISOString(),
                graded: false
              };

              const userWorksheets = savedWorksheets[currentUser] || {};
              userWorksheets[id] = worksheet;

              const newWorksheets = {
                ...savedWorksheets,
                [currentUser]: userWorksheets
              };
              saveWorksheets(newWorksheets);

              setCurrentWorksheet(questions);
              setWorksheetId(id);
              setView('worksheet');
            }
          };

          const handleRegenerateWorksheet = (sourceWorksheetId, targetUser = currentUser) => {
            const sourceUserWorksheets = savedWorksheets[currentUser] || {};
            const sourceWorksheet = sourceUserWorksheets[sourceWorksheetId];
            
            if (!sourceWorksheet) return;

            // Create new worksheet with same questions but fresh state
            const newQuestions = sourceWorksheet.questions.map((q, idx) => ({
              ...q,
              id: idx,
              graded: false,
              correct: undefined,
              incomplete: undefined
            }));

            const newId = `WS-${Date.now()}`;
            const newWorksheet = {
              id: newId,
              questions: newQuestions,
              user: targetUser,
              createdAt: new Date().toISOString(),
              graded: false,
              categories: sourceWorksheet.categories || {},
              regeneratedFrom: sourceWorksheetId
            };

            const targetUserWorksheets = savedWorksheets[targetUser] || {};
            targetUserWorksheets[newId] = newWorksheet;

            const newWorksheets = {
              ...savedWorksheets,
              [targetUser]: targetUserWorksheets
            };
            saveWorksheets(newWorksheets);

            // Always switch to target user and show the worksheet
            setCurrentUser(targetUser);
            setWorksheetDisplayCount(5);
            setStatsDisplayCount(20);
            setCurrentWorksheet(newQuestions);
            setWorksheetId(newId);
            setView('worksheet');
          };

          const getMilestoneData = () => {
            const userData = getCurrentUserData();
            const questionHistory = userData.questionHistory;

            const typeGroups = {};

            Object.entries(questionHistory).forEach(([key, data]) => {
              const type = key.split(':')[0];
              if (!typeGroups[type]) {
                typeGroups[type] = {
                  type: type,
                  attempts: [],
                  totalAsked: 0,
                  totalCorrect: 0
                };
              }

              typeGroups[type].attempts = typeGroups[type].attempts.concat(data.attempts);
              typeGroups[type].totalAsked += data.totalAsked;
              typeGroups[type].totalCorrect += data.totalCorrect;
            });

            const milestoneData = [];
            Object.entries(typeGroups).forEach(([type, data]) => {
              if (data.totalAsked >= 50) {
                const blocks = [];
                const recent50Blocks = Math.floor(data.attempts.length / 50);
                if (recent50Blocks === 0 && data.attempts.length > 0) {
                  // less than 50 total, make one partial
                }

                for (let i = 0; i < recent50Blocks; i++) {
                  const startIdx = i * 50;
                  const endIdx = startIdx + 50;
                  const blockAttempts = data.attempts.slice(startIdx, endIdx);
                  const correct = blockAttempts.filter(a => a).length;
                  const percentage = (correct / blockAttempts.length) * 100;
                  blocks.push({
                    blockNum: i + 1,
                    percentage: percentage.toFixed(0),
                    questions: `${startIdx + 1}-${endIdx}`
                  });
                }

                const remaining = data.attempts.length % 100;
                if (remaining > 0) {
                  const startIdx = recent50Blocks * 50;
                  const blockAttempts = data.attempts.slice(startIdx);
                  const correct = blockAttempts.filter(a => a).length;
                  const percentage = (correct / blockAttempts.length) * 100;
                  blocks.push({
                    blockNum: recent50Blocks + 1,
                    percentage: percentage.toFixed(0),
                    questions: `${startIdx + 1}-${data.attempts.length}`,
                    partial: true
                  });
                }

                milestoneData.push({
                  type: type,
                  totalAsked: data.totalAsked,
                  blocks: blocks
                });
              }
            });

            milestoneData.sort((a, b) => a.type.localeCompare(b.type));
            return milestoneData;
          };

          const handleStartGrading = () => {
            setQuickGradeWrong('');
            setQuickGradeIncomplete('');
            setCurrentWorksheet(null);
            setWorksheetId(null);
            setSelectedWorksheetToGrade('');
            setView('grading');
          };

          const handleSelectWorksheetToGrade = (worksheetId) => {
            setGradingHistory([]);

            if (!worksheetId) {
              setCurrentWorksheet(null);
              setWorksheetId(null);
              setSelectedWorksheetToGrade('');
              return;
            }

            const userWorksheets = savedWorksheets[currentUser] || {};
            const worksheet = userWorksheets[worksheetId];
            if (worksheet) {
              setCurrentWorksheet(worksheet.questions);
              setWorksheetId(worksheetId);
              setSelectedWorksheetToGrade(worksheetId);
              setQuickGradeWrong('');
              setQuickGradeIncomplete('');
            }
          };

          const deleteWorksheet = (worksheetId) => {
            if (confirm(`Are you sure you want to delete worksheet ${worksheetId}?`)) {
              const userWorksheets = savedWorksheets[currentUser] || {};
              delete userWorksheets[worksheetId];

              const newWorksheets = {
                ...savedWorksheets,
                [currentUser]: userWorksheets
              };
              saveWorksheets(newWorksheets);

              if (worksheetId === selectedWorksheetToGrade) {
                setCurrentWorksheet(null);
                setWorksheetId(null);
                setSelectedWorksheetToGrade('');
              }
            }
          };

          const handleQuickGrade = () => {
            const parseNumbersWithRanges = (input) => {
              const numbers = [];
              const parts = input.split(',').map(p => p.trim());
              
              parts.forEach(part => {
                if (part.includes('-')) {
                  // Handle range like "90-100"
                  const [start, end] = part.split('-').map(n => parseInt(n.trim()));
                  if (!isNaN(start) && !isNaN(end) && start >= 1 && end <= 100 && start <= end) {
                    for (let i = start; i <= end; i++) {
                      numbers.push(i);
                    }
                  }
                } else {
                  // Handle single number
                  const num = parseInt(part);
                  if (!isNaN(num) && num >= 1 && num <= 100) {
                    numbers.push(num);
                  }
                }
              });
              
              return numbers;
            };

            const wrongNumbers = parseNumbersWithRanges(quickGradeWrong);
            const incompleteNumbers = parseNumbersWithRanges(quickGradeIncomplete);

            if ((wrongNumbers.length === 0 && quickGradeWrong.trim() !== '') ||
                (incompleteNumbers.length === 0 && quickGradeIncomplete.trim() !== '')) {
              alert('Please enter question numbers separated by commas (e.g., 5,12,23)');
              return;
            }

            const userData = getCurrentUserData();
            const newHistory = { ...userData.questionHistory };
            const batchGradeHistory = [];

            currentWorksheet.forEach((question) => {
              const isIncomplete = incompleteNumbers.includes(question.id + 1);
              const isWrong = wrongNumbers.includes(question.id + 1);
              const isCorrect = !isWrong && !isIncomplete;
              const key = question.key;

              // Save previous state for undo
              batchGradeHistory.push({
                questionId: question.id,
                wasCorrect: isCorrect,
                wasIncomplete: isIncomplete,
                key: key,
                previousUserData: userData.questionHistory[key] ? {...userData.questionHistory[key]} : null
              });

              if (!isIncomplete) {
                if (!newHistory[key]) {
                  newHistory[key] = { attempts: [], totalAsked: 0, totalCorrect: 0 };
                }

                newHistory[key].attempts.push(isCorrect);
                newHistory[key].totalAsked += 1;
                if (isCorrect) newHistory[key].totalCorrect += 1;
              }

              question.graded = true;
              question.correct = isCorrect;
              question.incomplete = isIncomplete;
            });

            saveUserData({ questionHistory: newHistory });

            const userWorksheets = savedWorksheets[currentUser] || {};
            if (userWorksheets[worksheetId]) {
              userWorksheets[worksheetId].graded = true;
              userWorksheets[worksheetId].questions = currentWorksheet;
              saveWorksheets({ ...savedWorksheets, [currentUser]: userWorksheets });
            }

            setCurrentWorksheet([...currentWorksheet]);
            
            // Add all grades to history as a batch
            setGradingHistory(prev => [...prev, ...batchGradeHistory]);
          };    

          const handleGradeQuestion = (questionId, isCorrect, isIncomplete = false) => {
            const question = currentWorksheet.find(q => q.id === questionId);
            const key = question.key;

            const userData = getCurrentUserData();
            const newHistory = { ...userData.questionHistory };

            if (!isIncomplete) {
              if (!newHistory[key]) {
                newHistory[key] = { attempts: [], totalAsked: 0, totalCorrect: 0 };
              }

              newHistory[key].attempts.push(isCorrect);
              newHistory[key].totalAsked += 1;
              if (isCorrect) newHistory[key].totalCorrect += 1;

              saveUserData({ questionHistory: newHistory });
            }

            const updated = currentWorksheet.map(q =>
              q.id === questionId ? { ...q, graded: true, correct: isCorrect, incomplete: isIncomplete } : q
            );
            setCurrentWorksheet(updated);

            // Save to grading history for undo
            setGradingHistory(prev => [...prev, {
              questionId,
              wasCorrect: isCorrect,
              wasIncomplete: isIncomplete,
              key: key,
              previousUserData: userData.questionHistory[key] ? {...userData.questionHistory[key]} : null
            }]);

            if (updated.every(q => q.graded)) {
              const userWorksheets = savedWorksheets[currentUser] || {};
              if (userWorksheets[worksheetId]) {
                userWorksheets[worksheetId].graded = true;
                userWorksheets[worksheetId].questions = updated;
                saveWorksheets({ ...savedWorksheets, [currentUser]: userWorksheets });
              }
            }
          };

          const handleUndoGrade = () => {
            if (gradingHistory.length === 0) return;

            const lastGrade = gradingHistory[gradingHistory.length - 1];
            const userData = getCurrentUserData();
            const newHistory = { ...userData.questionHistory };

            // Restore previous state in history
            if (!lastGrade.wasIncomplete) {
              if (lastGrade.previousUserData) {
                newHistory[lastGrade.key] = lastGrade.previousUserData;
              } else {
                delete newHistory[lastGrade.key];
              }
              saveUserData({ questionHistory: newHistory });
            }

            // Mark question as ungraded
            const updated = currentWorksheet.map(q =>
              q.id === lastGrade.questionId ? { ...q, graded: false, correct: undefined, incomplete: undefined } : q
            );
            setCurrentWorksheet(updated);

            // Remove from grading history
            setGradingHistory(prev => prev.slice(0, -1));
          };

          const handleUndoAll = () => {
            if (gradingHistory.length === 0) return;

            const userData = getCurrentUserData();
            const newHistory = { ...userData.questionHistory };

            // Restore all previous states
            gradingHistory.forEach(grade => {
              if (!grade.wasIncomplete) {
                if (grade.previousUserData) {
                  newHistory[grade.key] = grade.previousUserData;
                } else {
                  delete newHistory[grade.key];
                }
              }
            });

            saveUserData({ questionHistory: newHistory });

            // Mark all graded questions as ungraded
            const updated = currentWorksheet.map(q => ({
              ...q,
              graded: false,
              correct: undefined,
              incomplete: undefined
            }));
            setCurrentWorksheet(updated);

            // Clear all grading history
            setGradingHistory([]);
          };

          const allGraded = currentWorksheet?.every(q => q.graded);

          const getUngradedWorksheets = () => {
            const userWorksheets = savedWorksheets[currentUser] || {};
            return Object.values(userWorksheets).filter(w => !w.graded);
          };

          const getGradedWorksheets = () => {
            const userWorksheets = savedWorksheets[currentUser] || {};
            const graded = Object.values(userWorksheets).filter(w => w.graded);
            graded.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            return graded;
          };

          const formatShortDate = (isoDate) => {
            if (!isoDate) return '';
            const d = new Date(isoDate);
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
          };

          const renderSetup = () => {
            const userData = getCurrentUserData();
            const questionHistory = userData.questionHistory;
            const totalQuestions = Object.values(questionHistory).reduce((sum, data) => sum + data.totalAsked, 0);
            const milestoneData = getMilestoneData();

            return (
              <div className="max-w-6xl mx-auto p-6">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <div className="mb-6">
                  <h1 className="text-3xl font-bold text-gray-800">Basic Math Facts Worksheet Generator</h1>
                  {cloudUser && (
                    <div className="text-sm text-gray-600 mt-1">Logged in as: {authEmailDisplay}</div>
                  )}
                </div>

                <div className="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                  <div className="flex items-center space-x-4">
                    <label className="font-semibold">Current User:</label>
                    <select
                      value={currentUser}
                      onChange={(e) => {
                        setCurrentUser(e.target.value);
                        setWorksheetDisplayCount(5);
                        setStatsDisplayCount(20);
                      }}
                      className="border border-gray-300 rounded px-3 py-2 flex-1"
                    >
                      {users.map(user => (
                        <option key={user} value={user}>{user}</option>
                      ))}
                    </select>
                    <button
                      onClick={() => setShowUserModal(true)}
                      className="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700"
                    >
                      ‚ûï Add User
                    </button>
                    <button
                      onClick={() => setEditingUsers(true)}
                      className="bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700"
                    >
                      ‚úèÔ∏è Edit Users
                    </button>
                  </div>
                </div>

                {milestoneData.length > 0 && (
                  <div className="mb-8">
                    <h2 className="text-2xl font-semibold mb-4 text-gray-700">Progress Overview - {currentUser}</h2>
                    <div className="mb-4 p-3 bg-gray-50 border border-gray-300 rounded">
                      <p className="font-semibold">Total Questions Answered: {totalQuestions}</p>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b-2 border-gray-300">
                            <th className="text-left py-2 px-2">Question Type</th>
                            <th className="text-center py-2 px-2">Total</th>
                            {Array.from({length: Math.max(...milestoneData.map(m => m.blocks.length))}, (_, i) => (
                              <th key={i} className="text-center py-2 px-2">Block {i + 1}<br/><span className="text-xs text-gray-500">(Qs {i * 50 + 1}-{(i + 1) * 50})</span></th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {milestoneData.map((item, idx) => (
                            <tr key={idx} className="border-b border-gray-200">
                              <td className="py-3 px-2 font-semibold">{item.type}</td>
                              <td className="py-3 px-2 text-center">{item.totalAsked}</td>
                              {item.blocks.map((block, blockIdx) => (
                                <td key={blockIdx} className={`py-3 px-2 text-center ${block.partial ? 'bg-yellow-50' : ''}`}>
                                  <span className={`font-semibold ${parseFloat(block.percentage) >= 80 ? 'text-green-600' : parseFloat(block.percentage) >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                    {block.percentage}%
                                  </span>
                                  {block.partial && <span className="text-xs text-gray-500 block">({block.questions})</span>}
                                </td>
                              ))}
                              {Array.from({length: Math.max(...milestoneData.map(m => m.blocks.length)) - item.blocks.length}, (_, i) => (
                                <td key={`empty-${i}`} className="py-3 px-2 text-center text-gray-300">-</td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <p className="text-xs text-gray-500 mt-2">* Yellow background indicates incomplete block (less than 50 questions)</p>
                  </div>
                )}

                {milestoneData.length === 0 && (
                  <div className="mb-8 p-6 bg-gray-50 border border-gray-300 rounded text-center">
                    <p className="text-gray-600 text-lg">No progress data yet. Generate and grade some worksheets to see {currentUser}'s progress!</p>
                  </div>
                )}

                <div className="flex flex-wrap gap-4">
                  <button
                    onClick={() => setView('worksheetSettings')}
                    className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"
                  >
                    üìÑ Generate Worksheet
                  </button>

                  <button
                    onClick={() => setView('grading')}
                    className="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700"
                  >
                    ‚úì Grade Worksheet
                  </button>

                  <button
                    onClick={() => setView('progress')}
                    className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700"
                  >
                    üìä View Progress
                  </button>

                  <button
                    onClick={handleAuthButton}
                    disabled={loginInFlight || (INSTANTDB_APP_ID === 'YOUR_INSTANTDB_APP_ID')}
                    className={`px-6 py-3 rounded-lg font-semibold text-white ${cloudUser ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'} ${loginInFlight ? 'opacity-70 cursor-not-allowed' : ''}`}
                  >
                    {cloudUser ? 'Log Out' : 'Login to Save Data'}
                  </button>

                  <button
                    onClick={exportData}
                    className="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700"
                  >
                    üíæ Export Data
                  </button>

                  <label className="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 cursor-pointer">
                    üìÇ Import Data
                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                  </label>
                </div>
              </div>

              {showUserModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-lg p-6 max-w-md w-full">
                    <h2 className="text-xl font-bold mb-4">Add New User</h2>
                    <input
                      type="text"
                      value={newUserName}
                      onChange={(e) => setNewUserName(e.target.value)}
                      placeholder="Enter name"
                      className="border border-gray-300 rounded px-3 py-2 w-full mb-4"
                      onKeyPress={(e) => e.key === 'Enter' && addUser()}
                    />
                    <div className="flex space-x-3">
                      <button
                        onClick={addUser}
                        className="flex-1 bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700"
                      >
                        Add
                      </button>
                      <button
                        onClick={() => {
                          setShowUserModal(false);
                          setNewUserName('');
                        }}
                        className="flex-1 bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {editingUsers && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-lg p-6 max-w-md w-full">
                    <h2 className="text-xl font-bold mb-4">Edit Users</h2>
                    <div className="space-y-2 mb-4 max-h-96 overflow-y-auto">
                      {users.map(user => (
                        <div key={user} className="flex items-center justify-between p-3 border border-gray-300 rounded">
                          <span className="font-semibold">{user}</span>
                          <button
                            onClick={() => deleteUser(user)}
                            className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                          >
                            Delete
                          </button>
                        </div>
                      ))}
                    </div>
                    <button
                      onClick={() => setEditingUsers(false)}
                      className="w-full bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700"
                    >
                      Close
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
          };

          const renderWorksheetSettings = () => {
            const selectAll = () => {
              setCategories({
                numberBonds5: true,
                numberBonds10: true,
                numberBonds100: true,
                additionSingle: true,
                additionDoubleNoCarry: true,
                additionDoubleCarry: true,
                subtractionSingle: true,
                subtractionDoubleNoCarry: true,
                subtractionDoubleCarry: true,
                multiplication: [1,2,3,4,5,6,7,8,9,10,11,12],
                division: [1,2,3,4,5,6,7,8,9,10,11,12]
              });
            };

            const selectNone = () => {
              setCategories({
                numberBonds5: false,
                numberBonds10: false,
                numberBonds100: false,
                additionSingle: false,
                additionDoubleNoCarry: false,
                additionDoubleCarry: false,
                subtractionSingle: false,
                subtractionDoubleNoCarry: false,
                subtractionDoubleCarry: false,
                multiplication: [],
                division: []
              });
            };
            return (
              <div className="max-w-4xl mx-auto p-6">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h1 className="text-3xl font-bold mb-6 text-gray-800">Generate Worksheet for {currentUser}</h1>

                  <div className="mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-gray-700">Select Question Types</h2>

                    <div className="mb-6">
                      <h3 className="font-semibold mb-3 text-gray-600">Number Bonds</h3>
                      <div className="grid grid-cols-3 gap-4">
                        <label className="flex items-center space-x-3">
                          <input
                            type="checkbox"
                            checked={categories.numberBonds5}
                            onChange={(e) => setCategories({ ...categories, numberBonds5: e.target.checked })}
                            className="w-5 h-5"
                          />
                          <span>Number Bonds to 5</span>
                        </label>

                        <label className="flex items-center space-x-3">
                          <input
                            type="checkbox"
                            checked={categories.numberBonds10}
                            onChange={(e) => setCategories({ ...categories, numberBonds10: e.target.checked })}
                            className="w-5 h-5"
                          />
                          <span>Number Bonds to 10</span>
                        </label>

                        <label className="flex items-center space-x-3">
                          <input
                            type="checkbox"
                            checked={categories.numberBonds100}
                            onChange={(e) => setCategories({ ...categories, numberBonds100: e.target.checked })}
                            className="w-5 h-5"
                          />
                          <span>Number Bonds to 100</span>
                        </label>
                      </div>
                    </div>

                    <div className="mb-6">
                      <h3 className="font-semibold mb-3 text-gray-600">Addition / Subtraction</h3>
                      <div className="space-y-3">
                        <div className="grid grid-cols-3 gap-4">
                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.additionSingle}
                              onChange={(e) => setCategories({ ...categories, additionSingle: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Addition Single Digit</span>
                          </label>

                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.additionDoubleNoCarry}
                              onChange={(e) => setCategories({ ...categories, additionDoubleNoCarry: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Addition Double Digit (no carrying)</span>
                          </label>

                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.additionDoubleCarry}
                              onChange={(e) => setCategories({ ...categories, additionDoubleCarry: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Addition Double Digit (carrying)</span>
                          </label>
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.subtractionSingle}
                              onChange={(e) => setCategories({ ...categories, subtractionSingle: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Subtraction Single Digit</span>
                          </label>

                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.subtractionDoubleNoCarry}
                              onChange={(e) => setCategories({ ...categories, subtractionDoubleNoCarry: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Subtraction Double Digit (no borrowing)</span>
                          </label>

                          <label className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={categories.subtractionDoubleCarry}
                              onChange={(e) => setCategories({ ...categories, subtractionDoubleCarry: e.target.checked })}
                              className="w-5 h-5"
                            />
                            <span>Subtraction Double Digit (borrowing)</span>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div className="mt-6">
                      <h3 className="font-semibold mb-2">Multiplication Tables</h3>
                      <div className="grid grid-cols-6 gap-2">
                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(n => (
                          <label key={n} className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              checked={categories.multiplication.includes(n)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setCategories({ ...categories, multiplication: [...categories.multiplication, n] });
                                } else {
                                  setCategories({ ...categories, multiplication: categories.multiplication.filter(x => x !== n) });
                                }
                              }}
                              className="w-4 h-4"
                            />
                            <span>{n}√ó</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="mt-6">
                      <h3 className="font-semibold mb-2">Division Tables</h3>
                      <div className="grid grid-cols-6 gap-2">
                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(n => (
                          <label key={n} className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              checked={categories.division.includes(n)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setCategories({ ...categories, division: [...categories.division, n] });
                                } else {
                                  setCategories({ ...categories, division: categories.division.filter(x => x !== n) });
                                }
                              }}
                              className="w-4 h-4"
                            />
                            <span>√∑{n}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="mb-8 flex justify-start space-x-4">
                    <button
                      onClick={selectAll}
                      className="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700"
                    >
                      ‚úì Select All
                    </button>
                    <button
                      onClick={selectNone}
                      className="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700"
                    >
                      ‚úó Select None
                    </button>
                  </div>

                  <div className="mb-8">
                    <h2 className="text-xl font-semibold mb-4 text-gray-700">Adaptive Learning Weight</h2>
                    <div className="flex items-center space-x-4">
                      <span className="text-sm">Random</span>
                      <input
                        type="range"
                        min="0"
                        max="1"
                        step="0.1"
                        value={adaptiveWeight}
                        onChange={(e) => setAdaptiveWeight(parseFloat(e.target.value))}
                        className="flex-1"
                      />
                      <span className="text-sm">Focus Struggles</span>
                    </div>
                    <p className="text-sm text-gray-600 mt-2">Current: {adaptiveWeight.toFixed(1)}</p>
                  </div>

                  <div className="flex space-x-4">
                    <button
                      onClick={handleGenerateWorksheet}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"
                    >
                      üìÑ Generate Worksheet
                    </button>

                    <button
                      onClick={() => setView('setup')}
                      className="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700"
                    >
                      ‚Üê Back
                    </button>
                  </div>
                </div>
              </div>
          );
         };
          const renderWorksheet = () => {
            const columns = [[], [], [], []];
            currentWorksheet.forEach((q, idx) => {
              const col = Math.floor(idx / 25);
              columns[col].push({ ...q, displayNum: idx + 1 });
            });

            return (
              <div id="printable" className="p-8 bg-white" style={{ width: '210mm', minHeight: '297mm', margin: '0 auto' }}>
                <div className="mb-6 border-b-2 border-gray-300 pb-4">
                  <h1 className="text-4xl font-bold text-center mb-4">Math Practice</h1>
                  <div className="flex justify-between text-sm mb-2">
                    <div>Name: <span className="font-semibold">{currentUser}</span></div>
                    <div className="font-bold text-lg">ID: {worksheetId}</div>
                  </div>
                  <div className="flex justify-between text-sm">
                    <div>Date: _________________________</div>
                    <div>Time Taken: _________ minutes</div>
                  </div>
                  <div className="text-right text-sm mt-1">
                    <div>Score: _____ / 100</div>
                  </div>
                </div>

                <div className="grid grid-cols-4 gap-x-6 text-sm">
                  {columns.map((column, colIdx) => (
                    <div key={colIdx} className="space-y-3">
                      {column.map((q) => (
                        <div key={q.displayNum} className="flex items-center space-x-2">
                          <span className="text-gray-500 w-7">{q.displayNum}.</span>
                          <span className="font-mono">{q.display}</span>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>

                <div className="mt-6 text-sm text-gray-600 border-t border-gray-300 pt-2">
                  <strong>Question Types:</strong>{' '}
                  {Array.from(new Set(currentWorksheet.map(q => q.type)))
                    .sort((a, b) => {
                      const order = [
                        'numberBonds5',
                        'numberBonds10',
                        'numberBonds100',
                        'additionSingle',
                        'additionDoubleNoCarry',
                        'additionDoubleCarry',
                        'subtractionSingle',
                        'subtractionDoubleNoCarry',
                        'subtractionDoubleCarry',
                      ...Array.from({length: 12}, (_, i) => `multiplication${i + 1}`),
                      ...Array.from({length: 12}, (_, i) => `division${i + 1}`)
                    ];
                    return order.indexOf(a) - order.indexOf(b);
                    })
                    .join(', ')
                  }
                </div>

                <div className="mt-8 flex justify-center space-x-4 print:hidden">
                  <button
                    onClick={() => window.print()}
                    className="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700"
                  >
                    üñ®Ô∏è Print Worksheet
                  </button>

                  <button
                    onClick={() => setView('setup')}
                    className="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700"
                  >
                    ‚Üê Back to Start
                  </button>
                </div>
              </div>
            );
          };

          const renderGrading = () => {
            const ungradedWorksheets = getUngradedWorksheets();

            const columns = [[], [], [], []];
            if (currentWorksheet) {
              currentWorksheet.forEach((q, idx) => {
                const col = Math.floor(idx / 25);
                columns[col].push({ ...q, displayNum: idx + 1 });
              });
            }

            return (
              <div className="max-w-6xl mx-auto p-6">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h1 className="text-2xl font-bold mb-6">Grade Worksheet</h1>

                  <div className="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                    <h3 className="font-semibold mb-3">Select Worksheet to Grade</h3>
                    <div className="flex items-center space-x-3">
                      <select
                        value={selectedWorksheetToGrade}
                        onChange={(e) => handleSelectWorksheetToGrade(e.target.value)}
                        className="border border-gray-300 rounded px-3 py-2 flex-1"
                      >
                        <option value="">-- Select a worksheet --</option>
                        {ungradedWorksheets.map(ws => (
                          <option key={ws.id} value={ws.id}>
                            {ws.id} (Created: {new Date(ws.createdAt).toLocaleDateString()})
                          </option>
                        ))}
                      </select>
                      {selectedWorksheetToGrade && (
                        <button
                          onClick={() => deleteWorksheet(selectedWorksheetToGrade)}
                          className="bg-red-600 text-white px-4 py-2 rounded font-semibold hover:bg-red-700"
                        >
                          üóëÔ∏è Delete
                        </button>
                      )}
                    </div>
                    {ungradedWorksheets.length === 0 && (
                      <p className="text-sm text-gray-600 mt-2">No ungraded worksheets found. Generate a new worksheet to get started!</p>
                    )}
                  </div>

                  {currentWorksheet && (
                    <>
                      {allGraded && (
                        <div className="mb-6 p-4 bg-green-100 border border-green-400 rounded">
                          <p className="font-semibold text-green-800">All questions graded!
                            Score: {currentWorksheet.filter(q => q.correct).length}/100
                          </p>
                        </div>
                      )}

                      {!allGraded && (
                        <div className="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                          <h3 className="font-semibold mb-2">Quick Grade Mode</h3>
                          <p className="text-sm text-gray-700 mb-3">Enter the question numbers separated by commas (e.g., 5,12,23,47)</p>
                          <div className="space-y-3">
                            <div className="flex items-center space-x-3">
                              <label className="w-32 font-semibold">Wrong:</label>
                              <input
                                type="text"
                                value={quickGradeWrong}
                                onChange={(e) => setQuickGradeWrong(e.target.value)}
                                placeholder="e.g., 5,12,23,90-100"
                                className="flex-1 border border-gray-300 rounded px-3 py-2"
                              />
                            </div>
                            <div className="flex items-center space-x-3">
                              <label className="w-32 font-semibold">Incomplete:</label>
                              <input
                                type="text"
                                value={quickGradeIncomplete}
                                onChange={(e) => setQuickGradeIncomplete(e.target.value)}
                                placeholder="e.g., 89,90,91,95-100"
                                className="flex-1 border border-gray-300 rounded px-3 py-2"
                              />
                            </div>
                            <button
                              onClick={handleQuickGrade}
                              className="w-full bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700"
                            >
                              Grade All
                            </button>
                          </div>
                          <p className="text-xs text-gray-500 mt-2">Leave both blank if all questions are correct!</p>
                        </div>
                      )}

                      {gradingHistory.length > 0 && (
                        <div className="mb-4 flex space-x-3">
                          <button
                            onClick={() => {
                              setCurrentWorksheet(null);
                              setWorksheetId(null);
                              setSelectedWorksheetToGrade('');
                              setView('setup');
                            }}
                            className="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700"
                          >
                            ‚Üê Back to Start
                          </button>
                          <button
                            onClick={handleUndoGrade}
                            className="bg-orange-600 text-white px-4 py-2 rounded font-semibold hover:bg-orange-700"
                          >
                            ‚Ü∂ Undo Last Grade
                          </button>
                          <button
                            onClick={handleUndoAll}
                            className="bg-red-600 text-white px-4 py-2 rounded font-semibold hover:bg-red-700"
                          >
                            ‚Ü∫ Undo All
                          </button>
                        </div>
                      )}

                      {gradingHistory.length === 0 && (
                        <div className="mb-4">
                          <button
                            onClick={() => {
                              setCurrentWorksheet(null);
                              setWorksheetId(null);
                              setSelectedWorksheetToGrade('');
                              setView('setup');
                            }}
                            className="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700"
                          >
                            ‚Üê Back to Start
                          </button>
                        </div>
                      )}

                      <h3 className="font-semibold mb-3">Or grade individually:</h3>
                      <div className="grid grid-cols-4 gap-6 mb-6">
                        {columns.map((column, colIdx) => (
                          <div key={colIdx} className="space-y-3">
                            {column.map((q) => (
                              <div key={q.id} className={`p-3 border rounded ${
                                q.graded ? (
                                  q.incomplete ? 'bg-gray-50 border-gray-300' :
                                  q.correct ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'
                                ) : 'border-gray-300'
                              }`}>
                                <div className="text-sm font-mono mb-2">{q.displayNum}. {q.display}</div>
                                <div className="text-xs text-gray-600 mb-2">Answer: {q.answer}</div>
                                {!q.graded ? (
                                  <div className="flex space-x-1">
                                    <button
                                      onClick={() => handleGradeQuestion(q.id, true, false)}
                                      className="flex-1 bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600"
                                      title="Correct"
                                    >
                                      ‚úì
                                    </button>
                                    <button
                                      onClick={() => handleGradeQuestion(q.id, false, false)}
                                      className="flex-1 bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"
                                      title="Wrong"
                                    >
                                      ‚úó
                                    </button>
                                    <button
                                      onClick={() => handleGradeQuestion(q.id, false, true)}
                                      className="flex-1 bg-gray-400 text-white px-2 py-1 rounded text-xs hover:bg-gray-500"
                                      title="Incomplete"
                                    >
                                      ‚Ä¢
                                    </button>
                                  </div>
                                ) : (
                                  <div className="text-center font-semibold text-xs">
                                    {q.incomplete ? '‚Ä¢ Incomplete' : q.correct ? '‚úì Correct' : '‚úó Wrong'}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        ))}
                      </div>
                    </>
                  )}

                  <button
                    onClick={() => {
                      setCurrentWorksheet(null);
                      setWorksheetId(null);
                      setSelectedWorksheetToGrade('');
                      setView('setup');
                    }}
                    className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700"
                  >
                    ‚Üê Back to Start
                  </button>
                </div>
              </div>
            );
          };

          const renderProgress = () => {
            const userData = getCurrentUserData();
            const questionHistory = userData.questionHistory;

            const stats = Object.entries(questionHistory).map(([key, data]) => {
              const recent = data.attempts.slice(-20);
              const recentCorrect = recent.filter(a => a).length;
              const recentPercentage = recent.length > 0 ? (recentCorrect / recent.length) * 100 : 0;
              const overallPercentage = data.totalAsked > 0 ? (data.totalCorrect / data.totalAsked) * 100 : 0;
              return {
                question: key.split(':')[1],
                type: key.split(':')[0],
                totalAsked: data.totalAsked,
                overallPercentage: overallPercentage.toFixed(0),
                recentPercentage: recentPercentage.toFixed(0),
                recentAttempts: recent.length,
                key
              };
            }).sort((a, b) => parseFloat(a.recentPercentage) - parseFloat(b.recentPercentage));

            const totalQuestions = Object.values(questionHistory).reduce((sum, data) => sum + data.totalAsked, 0);

            const gradedWorksheets = getGradedWorksheets();
            const ungradedWorksheets = getUngradedWorksheets();
            const allWorksheets = [...gradedWorksheets, ...ungradedWorksheets].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const visibleWorksheets = allWorksheets.slice(0, worksheetDisplayCount);
            const visibleStats = stats.slice(0, statsDisplayCount);

            return (
              <div className="max-w-6xl mx-auto p-6">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h1 className="text-2xl font-bold mb-6">Detailed Progress Report - {currentUser}</h1>

                  <div className="mb-6 p-4 bg-blue-50 border border-blue-300 rounded">
                    <p className="font-semibold">Total Questions Answered: {totalQuestions}</p>
                  </div>

                  <div className="mb-8">
                    <button
                      onClick={() => setView('setup')}
                      className="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700 mb-4"
                    >
                      ‚Üê Back to Start
                    </button>
                    <h2 className="text-xl font-semibold mb-4">Previous Worksheet Results</h2>

                    {visibleWorksheets.length === 0 ? (
                      <div className="p-6 bg-gray-50 border border-gray-300 rounded text-center">
                        <p className="text-gray-600">No graded worksheets yet. Generate and grade some worksheets to see results!</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b-2 border-gray-300">
                              <th className="text-center py-2 w-20">Date</th>
                              <th className="text-center py-2 w-20">Score</th>
                              <th className="text-left py-2 w-36">Worksheet ID</th>
                              <th className="text-left py-2 w-66">Question Types</th>
                              <th className="text-center py-2 w-20">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {visibleWorksheets.map((ws, idx) => {
                              const totalQs = Array.isArray(ws.questions) ? ws.questions.length : 0;
                              const correct = ws.questions ? ws.questions.filter(q => q.correct).length : 0;
                              const percent = totalQs > 0 ? Math.round((correct / totalQs) * 100) : 0;
                              const typeOrder = [
                                'numberBonds5',
                                'numberBonds10',
                                'numberBonds100',
                                'additionSingle',
                                'additionDoubleNoCarry',
                                'additionDoubleCarry',
                                'subtractionSingle',
                                'subtractionDoubleNoCarry',
                                'subtractionDoubleCarry',
                                ...Array.from({length: 12}, (_, i) => `multiplication${i + 1}`),
                                ...Array.from({length: 12}, (_, i) => `division${i + 1}`)
                              ];

                              const types = Array.from(new Set((ws.questions || []).map(q => q.type)))
                                .sort((a, b) => typeOrder.indexOf(a) - typeOrder.indexOf(b))
                                .join(', ');

                              return (
                                <tr key={ws.id} className="border-b border-gray-200">
                                <td className="py-2 text-center">{ws.graded ? formatShortDate(ws.createdAt) : '-'}</td>
                                <td className="py-2 text-center">
                                  {ws.graded ? (
                                    <span className={`font-semibold ${
                                      percent >= 80 ? 'text-green-600' :
                                      percent >= 60 ? 'text-yellow-600' :
                                      'text-red-600'
                                    }`}>
                                      {percent}%
                                    </span>
                                  ) : (
                                    <span className="text-gray-400">-</span>
                                  )}
                                </td>
                                <td className="py-2 font-mono">{ws.id}</td>
                                <td className="py-2 text-xs">{types}</td>
                                <td className="py-2 text-center">
                                  <select
                                    onChange={(e) => {
                                      if (e.target.value) {
                                        handleRegenerateWorksheet(ws.id, e.target.value);
                                        e.target.value = '';
                                      }
                                    }}
                                    className="text-xs border border-gray-300 rounded px-2 py-1"
                                  >
                                    <option value="">Copy to...</option>
                                    <option value={currentUser}>üìã {currentUser} (me)</option>
                                    {users.filter(u => u !== currentUser).map(user => (
                                      <option key={user} value={user}>üë§ {user}</option>
                                    ))}
                                  </select>
                                </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}

                    {allWorksheets.length > visibleWorksheets.length && (
                      <div className="mt-4 text-center">
                        <button
                          onClick={() => setWorksheetDisplayCount(prev => prev + 20)}
                          className="bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700"
                        >
                          Show More Results
                        </button>
                      </div>
                    )}
                  </div>

                  {stats.length === 0 ? (
                    <p className="text-gray-600">No data yet. Generate and grade some worksheets to see progress!</p>
                  ) : (
                    <div>
                      <h2 className="text-xl font-semibold mb-4">Individual Question Performance</h2>
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b-2 border-gray-300">
                              <th className="text-left py-2">Question</th>
                              <th className="text-left py-2">Type</th>
                              <th className="text-center py-2">Times Asked</th>
                              <th className="text-center py-2">Overall %</th>
                              <th className="text-center py-2">Recent % (last 20)</th>
                            </tr>
                          </thead>
                          <tbody>
                            {visibleStats.map((stat, idx) => (
                              <tr key={idx} className="border-b border-gray-200">
                                <td className="py-2 font-mono">{stat.question}</td>
                                <td className="py-2 text-gray-600">{stat.type}</td>
                                <td className="py-2 text-center">{stat.totalAsked}</td>
                                <td className="py-2 text-center">
                                  <span className={`font-semibold ${parseFloat(stat.overallPercentage) >= 80 ? 'text-green-600' : parseFloat(stat.overallPercentage) >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                    {stat.overallPercentage}%
                                  </span>
                                </td>
                                <td className="py-2 text-center">
                                  <span className={`font-semibold ${parseFloat(stat.recentPercentage) >= 80 ? 'text-green-600' : parseFloat(stat.recentPercentage) >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                                    {stat.recentPercentage}% ({stat.recentAttempts})
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      {stats.length > visibleStats.length && (
                        <div className="mt-4 text-center">
                          <button
                            onClick={() => setStatsDisplayCount(prev => prev + 20)}
                            className="bg-gray-600 text-white px-4 py-2 rounded font-semibold hover:bg-gray-700"
                          >
                            Show More Results
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-100">
              {view === 'setup' && renderSetup()}
              {view === 'worksheetSettings' && renderWorksheetSettings()}
              {view === 'worksheet' && renderWorksheet()}
              {view === 'grading' && renderGrading()}
              {view === 'progress' && renderProgress()}
            </div>
          );
        };

        ReactDOM.render(<MathPracticeApp />, document.getElementById('root'));
    </script>
</body>
</html>
                